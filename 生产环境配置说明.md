# 生产环境配置说明

## 📋 概述

本文档说明如何在生产环境（`http://47.106.73.160/`）配置前端和后端服务，使用 Nginx 反向代理方案。

## 🏗️ 架构说明

### 当前架构
- **前端**: 静态文件部署在 `http://47.106.73.160/`（Nginx 80 端口）
- **后端**: Node.js 服务运行在 `localhost:3001`（仅服务器内部访问）
- **API 代理**: Nginx 将 `/api/*` 请求反向代理到 `http://localhost:3001/api/*`

### 优势
✅ 后端不直接暴露端口，更安全  
✅ 统一域名，避免 CORS 问题  
✅ 客户端使用相对路径，无需知道后端端口  
✅ 支持文件上传（已配置大文件上传支持）

## 🔧 配置步骤

### 1. 服务器端配置

#### 1.1 部署后端服务

确保后端服务在服务器上运行：

```bash
# 在服务器上
cd /path/to/server
npm install
npm start
# 或使用 PM2 管理进程
pm2 start server.js --name sgc-backend
```

后端服务应监听 `0.0.0.0:3001` 或 `localhost:3001`。

#### 1.2 配置 Nginx

**方式一：使用部署脚本（推荐）**

运行服务器端部署脚本：

```bash
# 上传并运行部署脚本
scp server-deploy.sh root@47.106.73.160:/tmp/
ssh root@47.106.73.160 "bash /tmp/server-deploy.sh"
```

脚本会自动：
- 安装 Nginx（如果未安装）
- 创建包含 API 反向代理的 Nginx 配置
- 启用站点并重启 Nginx

**方式二：手动配置**

将 `nginx-main-server.conf` 上传到服务器：

```bash
scp nginx-main-server.conf root@47.106.73.160:/etc/nginx/sites-available/sgc_website
```

在服务器上创建符号链接并重启：

```bash
ln -s /etc/nginx/sites-available/sgc_website /etc/nginx/sites-enabled/
nginx -t  # 测试配置
systemctl restart nginx
```

### 2. 环境变量配置

#### 2.1 开发环境 (`.env.local`)

```bash
# 服务器端使用（Next.js API 路由）
BACKEND_URL=http://localhost:3001

# 客户端使用（浏览器端，开发时使用相对路径）
NEXT_PUBLIC_API_URL=http://localhost:3001
```

#### 2.2 生产环境

**如果使用 Next.js SSR（服务器端渲染）：**

在部署平台（如 Vercel）或服务器环境变量中设置：

```bash
# 服务器端使用
BACKEND_URL=http://localhost:3001

# 客户端使用（通过 Nginx 代理）
NEXT_PUBLIC_API_URL=http://47.106.73.160/api
```

**如果使用静态导出（当前方案）：**

由于静态导出不支持 Next.js API 路由，客户端会直接通过 Nginx 代理访问后端，所以：

```bash
# 构建时不需要设置 NEXT_PUBLIC_API_URL
# 客户端代码使用相对路径 /api，由 Nginx 代理
```

### 3. 构建和部署

#### 3.1 构建前端

```bash
# 开发环境构建
npm run build

# 生产环境构建（IP 地址部署，不使用 basePath）
BASE_PATH= NEXT_PUBLIC_BASE_PATH= NODE_ENV=production npm run build
```

#### 3.2 部署前端

使用部署脚本：

```bash
npm run deploy
# 或
./deploy.sh
```

## 🔍 验证配置

### 1. 检查后端服务

```bash
# 在服务器上测试后端
curl http://localhost:3001/health
# 应该返回: {"status":"ok","message":"Server is running"}
```

### 2. 检查 Nginx 代理

```bash
# 从服务器内部测试
curl http://localhost/api/experts
# 应该返回专家列表数据
```

### 3. 检查前端访问

在浏览器访问：
- 前端首页: `http://47.106.73.160/`
- 管理后台: `http://47.106.73.160/admin`
- API 测试: `http://47.106.73.160/api/experts`

## 📝 重要说明

### 当前实现方式

由于项目使用静态导出（`output: 'export'`），Next.js API 路由在生产环境不会工作。因此：

1. **开发环境**: 
   - 客户端请求 `/api/experts` → Next.js API 路由 (`app/api/experts/route.ts`) → 后端 `localhost:3001`
   
2. **生产环境**:
   - 客户端请求 `/api/experts` → Nginx 反向代理 → 后端 `localhost:3001`

### 管理后台页面

管理后台页面（`/admin/*`）已经在使用相对路径 `/api`，所以：
- ✅ 开发环境：通过 Next.js API 路由代理
- ✅ 生产环境：通过 Nginx 反向代理
- ✅ 无需修改代码

## 🚨 故障排查

### 问题 1: API 请求返回 502 Bad Gateway

**原因**: 后端服务未运行或无法访问

**解决**:
```bash
# 检查后端服务状态
ps aux | grep node
# 或
pm2 list

# 启动后端服务
cd /path/to/server
npm start
```

### 问题 2: API 请求返回 404

**原因**: Nginx 配置未生效

**解决**:
```bash
# 检查 Nginx 配置
nginx -t

# 重新加载配置
systemctl reload nginx

# 检查 Nginx 日志
tail -f /var/log/nginx/sgc_website_error.log
```

### 问题 3: 文件上传失败

**原因**: 文件大小超过限制

**解决**: Nginx 配置中已设置 `client_max_body_size 10M`，如需更大，修改配置后重启 Nginx。

## 🔒 安全建议

1. **后端服务**: 仅监听 `localhost:3001`，不要监听 `0.0.0.0:3001`
2. **防火墙**: 确保 3001 端口不对外开放，只允许本地访问
3. **HTTPS**: 生产环境建议配置 HTTPS（需要 SSL 证书）
4. **身份验证**: 管理后台应添加身份验证保护

## 📚 相关文件

- `nginx-main-server.conf` - Nginx 主配置文件（包含 API 代理）
- `server-deploy.sh` - 服务器端部署脚本
- `deploy.sh` - 前端部署脚本
- `server/server.js` - 后端服务入口文件

