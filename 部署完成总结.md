# ✅ Nginx 反向代理配置 - 部署总结

## 🎉 已完成的配置

### 1. 配置文件更新
- ✅ **`nginx-main-server.conf`** - 已添加 API 反向代理配置
  - 将 `/api/*` 请求代理到 `http://localhost:3001/api/*`
  - 支持文件上传（最大 10M）
  - 配置了超时时间（60秒）

- ✅ **`server-deploy.sh`** - 已更新部署脚本
  - 生成的 Nginx 配置包含反向代理

- ✅ **`deploy-nginx-proxy.sh`** - 创建了自动部署脚本
  - 自动备份现有配置
  - 上传新配置
  - 测试并重启 Nginx
  - 验证后端服务和 API 代理

### 2. 文档
- ✅ **`生产环境配置说明.md`** - 详细配置说明
- ✅ **`Nginx反向代理部署指南.md`** - 快速部署指南
- ✅ **`手动部署Nginx配置.md`** - 手动部署步骤

## 🚀 下一步操作

### 选项 A: 使用自动部署脚本（推荐）

**前提条件**: 需要安装 `sshpass`

```bash
# 1. 安装 sshpass
brew install hudochenkov/sshpass/sshpass

# 2. 运行自动部署脚本
./deploy-nginx-proxy.sh
```

### 选项 B: 手动部署（无需额外工具）

按照 `手动部署Nginx配置.md` 中的步骤操作：

1. **上传配置文件到服务器**
   ```bash
   scp nginx-main-server.conf root@47.106.73.160:/tmp/
   ```

2. **SSH 到服务器并执行命令**
   ```bash
   ssh root@47.106.73.160
   # 然后按照手动部署文档中的步骤操作
   ```

## 📋 部署前检查清单

在部署 Nginx 配置之前，确保：

- [ ] **后端服务已部署到服务器**
  - 后端代码已上传到服务器
  - 依赖已安装（`npm install`）
  - 服务运行在 `localhost:3001`

- [ ] **后端服务正在运行**
  ```bash
  # 在服务器上检查
  curl http://localhost:3001/health
  # 应该返回: {"status":"ok","message":"Server is running"}
  ```

- [ ] **后端服务配置正确**
  - 监听地址：`localhost:3001` 或 `0.0.0.0:3001`
  - 端口：3001
  - API 路径：`/api/experts` 和 `/api/research-structure`

## 🔍 部署后验证

部署完成后，验证以下内容：

### 1. 检查 Nginx 配置
```bash
# 在服务器上
nginx -t
systemctl status nginx
```

### 2. 测试后端服务
```bash
# 在服务器上
curl http://localhost:3001/health
```

### 3. 测试 API 代理
```bash
# 在服务器上
curl http://localhost/api/experts
```

### 4. 浏览器测试
- 访问: http://47.106.73.160/admin
- 尝试修改专家信息并保存
- 检查浏览器控制台是否有错误

## 📝 配置说明

### 开发环境
- 后端地址: `http://localhost:3001`
- API 调用: 通过 Next.js API 路由代理

### 生产环境
- 后端地址: `http://localhost:3001`（服务器内部）
- API 调用: 通过 Nginx 反向代理 `/api/*` → `http://localhost:3001/api/*`
- 客户端使用相对路径 `/api`，无需知道后端端口

## 🎯 架构图

```
客户端浏览器
  ↓ GET /api/experts
Nginx (47.106.73.160:80)
  ↓ 反向代理
后端服务 (localhost:3001)
  ↓ 响应数据
Nginx
  ↓ 返回给客户端
客户端浏览器
```

## ⚠️ 重要提醒

1. **后端服务必须运行**: Nginx 代理需要后端服务在 `localhost:3001` 运行
2. **端口安全**: 确保 3001 端口不对外开放，只允许本地访问
3. **管理后台安全**: 当前没有身份验证，生产环境建议添加
4. **HTTPS**: 建议配置 SSL 证书启用 HTTPS

## 📚 相关文件

- `nginx-main-server.conf` - Nginx 主配置文件
- `deploy-nginx-proxy.sh` - 自动部署脚本
- `server-deploy.sh` - 服务器端部署脚本
- `手动部署Nginx配置.md` - 手动部署指南
- `生产环境配置说明.md` - 详细配置说明

## 🆘 需要帮助？

如果遇到问题，请查看：
1. `手动部署Nginx配置.md` - 故障排查部分
2. Nginx 错误日志: `/var/log/nginx/sgc_website_error.log`
3. 后端服务日志

---

**配置已准备就绪，请按照上述步骤进行部署！** 🚀

